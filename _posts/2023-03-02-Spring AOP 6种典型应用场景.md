---
layout: post
title: Spring AOP 6种典型应用场景
subtitle: A awesome site is here.
author: Olive
categories: java
tags: java spring aop
---

## 前言

> AOP 的使用，基本上都会涉及到自定义注解，一种非常常见的组合，就是自定义注解+AOP。

> 在开发中，AOP最大的作用就是重复代码简化。

1. 首先，自定义一个注解。
2. 定义 AOP 切面，在切面中，定义切点和通知，切点，也就是方法的拦截规则，我们可以按照注解来拦截，也就是某一个带有自定义注解的方法，将被我拦截下来。
3. 拦截下来之后，前置通知、后置通知、异常通知、返回通知还是环绕通知。

## 1.幂等性处理

+ Token 机制
+ 去重表
+ 利用 Redis 的 setnx
+ 设置状态字段
+ 上锁

1. 自定义注解。
2. 自定义切点。
3. 定义环绕通知，在环绕通知中，先通过上述五种思路中的任意一种，对方法执行的幂等性进行判断。

## 2.接口限流

推荐成熟方案 Alibaba 的 Sentinel

如果自己写？思路大致如下：

1. 自定义注解。
2. 在需要进行限流的接口方法上添加自定义注解，同时还可以设置一些限流的参数，例如时间窗口值、流量大小等。
3. 自定义切点，拦截到方法之后，在环绕通知中，可以通过 Redis 插件 redis-cell、通过漏斗算法去处理限流。

## 3.日志处理

AOP经典例子

## 4.多数据源处理

自定义多数据源：

> 从 Spring2.0.1 中引入了 AbstractRoutingDataSource 类，该类充当了 DataSource 的路由中介，它能够在运行时, 根据某种 key
> 值来动态切换到真正的 DataSource 上。
> > 大致的用法是提前准备好各种数据源，存入到一个 Map 中，Map 的 key 就是这个数据源的名字，Map 的 value 就是这个具体的数据源，然后再把这个
> > Map 配置到 AbstractRoutingDataSource 中，之后，每次执行数据库查询的时候，拿一个 key 出来，AbstractRoutingDataSource
> > 会找到具体的数据源去执行这次数据库操作。

思路大致如下：

1. 自定义注解。
2. 在需要切换数据源的方法上添加自定义注解。
3. 自定义切点，拦截到方法之后，在环绕通知中，根据注解中的配置，重新设置要执行的数据源。

## 5.方法权限处理

推荐成熟方案 Spring Security

如果自己写？思路大致如下：

1. 自定义注解。
2. 在需要进行校验的方法上添加自定义注解。
3. 自定义切点，拦截到方法之后，在环绕通知中，根据注解中的配置，查询处理权限。

## 6.事务处理

Spring提供注解，对于声明式事务，直接用现成的注解，本质上也是 AOP。

